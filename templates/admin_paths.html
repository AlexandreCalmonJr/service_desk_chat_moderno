{% extends "admin_base.html" %}

{% block title %}Admin - Trilhas - Service Desk{% endblock %}
{% block page_title %}Gerenciar Trilhas de Aprendizagem{% endblock %}

{% block content %}
    <div class="mb-8">
        <h2 class="text-2xl font-bold mb-4">Criar Nova Trilha</h2>
        <form method="POST" action="{{ url_for('admin_paths') }}" class="space-y-4">
            {{ form.csrf_token }}
            <div>
                <label for="name" class="block text-gray-700">Nome da Trilha</label>
                <input type="text" id="name" name="name" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring focus:ring-blue-300" required>
            </div>
            <div>
                <label for="reward_points" class="block text-gray-700">Pontos de Recompensa</label>
                <input type="number" id="reward_points" name="reward_points" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring focus:ring-blue-300" value="100" required>
            </div>
            <div>
                <label for="description" class="block text-gray-700">Descrição</label>
                <textarea id="description" name="description" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring focus:ring-blue-300"></textarea>
            </div>
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Criar Trilha</button>
        </form>

        <h3 class="text-xl font-semibold mt-6 mb-4">Importar de Ficheiro</h3>
        <form method="POST" action="{{ url_for('admin_paths') }}" enctype="multipart/form-data" class="space-y-4">
            {{ form.csrf_token }}
            <input type="hidden" name="action" value="import_paths">
            <div>
                <label for="path_file" class="block text-gray-700">Ficheiro JSON</label>
                <input type="file" id="path_file" name="path_file" accept=".json" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring focus:ring-blue-300" required>
            </div>
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Importar</button>
        </form>
    </div>

    <div>
        <h2 class="text-2xl font-bold mb-4">Gerir Trilhas Existentes</h2>
        <div class="space-y-6">
            {% for path in paths %}
                <div class="border p-4 rounded">
                    <h3 class="text-lg font-semibold">{{ path.name }}</h3>
                    <p>{{ path.description or 'Sem descrição' }}</p>
                    <div class="mt-2">
                        <a href="{{ url_for('admin_edit_path', path_id=path.id) }}" class="text-blue-500 hover:underline">Editar</a>
                        <form method="POST" action="{{ url_for('admin_delete_path', path_id=path.id) }}" class="inline">
                            {{ form.csrf_token }}
                            <button type="submit" class="text-red-500 hover:underline ml-4">Excluir</button>
                        </form>
                    </div>

                    <h4 class="text-md font-semibold mt-4">Desafios na Trilha:</h4>
                    {% if path.challenges %}
                        <ul class="list-disc pl-5">
                            {% for pc in path.challenges %}
                                <li>
                                    Passo {{ pc.step }}: {{ pc.challenge.title }}
                                    <form method="POST" action="{{ url_for('admin_remove_challenge_from_path', path_id=path.id, challenge_id=pc.challenge_id) }}" class="inline">
                                        {{ form.csrf_token }}
                                        <button type="submit" class="text-red-500 hover:underline ml-2">Remover</button>
                                    </form>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>Nenhum desafio nesta trilha ainda.</p>
                    {% endif %}

                    <form method="POST" action="{{ url_for('admin_paths') }}" class="mt-4 space-y-4">
                        {{ form.csrf_token }}
                        <input type="hidden" name="action" value="add_challenge">
                        <input type="hidden" name="path_id" value="{{ path.id }}">
                        <h4 class="text-md font-semibold">Adicionar Desafio à Trilha:</h4>
                        <div>
                            <label for="challenge_id_{{ path.id }}" class="block text-gray-700">Desafio</label>
                            <select id="challenge_id_{{ path.id }}" name="challenge_id" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring focus:ring-blue-300" required>
                                <option value="">Selecione um desafio</option>
                                {% for challenge in challenges %}
                                    <option value="{{ challenge.id }}">{{ challenge.title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="step_{{ path.id }}" class="block text-gray-700">Passo Nº</label>
                            <input type="number" id="step_{{ path.id }}" name="step" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring focus:ring-blue-300" required>
                        </div>
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Adicionar</button>
                    </form>
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}