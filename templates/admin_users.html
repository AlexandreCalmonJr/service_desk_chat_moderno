{% extends "admin_base.html" %}

{% block title %}Admin - Usuários - Service Desk{% endblock %}
{% block page_title %}Gerenciar Usuários{% endblock %}

{% block content %}
    <div>
        <table class="w-full border-collapse">
            <thead>
                <tr class="bg-gray-100">
                    <th class="border p-2">Nome</th>
                    <th class="border p-2">Email</th>
                    <th class="border p-2">Nível</th>
                    <th class="border p-2">Admin</th>
                    <th class="border p-2">Ações</th>
                    <th class="border p-2">Código de Convite</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                    <tr>
                        <td class="border p-2">{{ user.name }}</td>
                        <td class="border p-2">{{ user.email }}</td>
                        <td class="border p-2">
                            {% if user.level and user.level.insignia %}
                                {% if 'cloudinary' in user.level.insignia %}
                                    <img src="{{ user.level.insignia }}" alt="Insígnia" class="w-6 h-6 inline-block">
                                {% else %}
                                    {{ user.level.insignia }}
                                {% endif %}
                                {{ user.level.name if user.level else 'N/A' }}
                            {% endif %}
                        </td>
                        <td class="border p-2">{{ 'Sim' if user.is_admin else 'Não' }}</td>
                        <td class="border p-2">
                            {% if user.id != current_user.id %}
                                <form method="POST" action="{{ url_for('toggle_admin', user_id=user.id) }}" class="inline">
                                    {{ form.csrf_token }}
                                    <button type="submit" class="text-blue-500 hover:underline">
                                        {{ 'Remover Admin' if user.is_admin else 'Tornar Admin' }}
                                    </button>
                                </form>
                            {% endif %}
                        </td>
                        <td class="border p-2">
                            <form method="POST" action="{{ url_for('generate_invitation') }}" class="inline" onsubmit="return handleGenerateCode(event, {{ user.id }})">
                                {{ form.csrf_token }}
                                <input type="hidden" name="user_id" value="{{ user.id }}">
                                <button type="submit" class="text-blue-500 hover:underline">Gerar Código</button>
                            </form>
                            <span id="invitation-code-{{ user.id }}" class="ml-2"></span>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        <script>
            async function handleGenerateCode(event, userId) {
                event.preventDefault();
                const form = event.target;
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: new FormData(form)
                });
                const data = await response.json();
                if (data.code) {
                    document.getElementById(`invitation-code-${userId}`).textContent = data.code;
                } else {
                    alert('Erro ao gerar código de convite.');
                }
                return false;
            }
        </script>
    </div>
{% endblock %}