<div class="chat-container w-full max-w-4xl flex flex-col h-[calc(100vh-8rem)] bg-white dark:bg-gray-800 rounded-2xl shadow-2xl overflow-hidden">
    <!-- Chat Header -->
    <div class="chat-header bg-gradient-to-r from-blue-600 via-purple-600 to-blue-800 p-6 text-white relative overflow-hidden">
        <!-- Background Animation -->
        <div class="absolute inset-0 bg-gradient-to-r from-blue-400/20 to-purple-400/20 animate-pulse"></div>
        
        <!-- Header Content -->
        <div class="relative z-10 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm">
                    <i class="fas fa-robot text-xl"></i>
                </div>
                <div>
                    <h2 class="text-xl font-bold">Assistente IA</h2>
                    <p class="text-blue-100 text-sm">Online ‚Ä¢ Pronto para ajudar</p>
                </div>
            </div>
            
            <!-- Status Indicator -->
            <div class="flex items-center space-x-2">
                <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                <span class="text-sm text-blue-100">Conectado</span>
            </div>
        </div>
        
        <!-- Decorative Elements -->
        <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-16 translate-x-16"></div>
        <div class="absolute bottom-0 left-0 w-20 h-20 bg-white/5 rounded-full translate-y-10 -translate-x-10"></div>
    </div>

    <!-- Chat Body -->
    <div class="chat-body flex-1 overflow-y-auto p-6 space-y-6" id="chat-body">
        <!-- Welcome Message -->
        <div class="chat-message bot flex items-start space-x-4 animate-slide-in">
            <div class="avatar w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center flex-shrink-0 shadow-lg">
                <i class="fas fa-robot text-white text-sm"></i>
            </div>
            <div class="message-bubble bg-gradient-to-br from-gray-100 to-gray-50 dark:from-gray-700 dark:to-gray-600 p-4 rounded-2xl rounded-tl-md max-w-xs lg:max-w-md shadow-lg">
                <div class="flex items-center space-x-2 mb-2">
                    <span class="text-xs font-semibold text-blue-600 dark:text-blue-400 uppercase tracking-wide">Assistente</span>
                    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                </div>
                <p class="text-gray-800 dark:text-gray-100 leading-relaxed">
                    üëã Ol√°! Sou seu assistente de Service Desk. Como posso ajudar hoje? 
                </p>
                <div class="mt-3 flex flex-wrap gap-2">
                    <span class="inline-flex items-center px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-xs rounded-full">
                        <i class="fas fa-ticket-alt mr-1"></i>
                        Chamados
                    </span>
                    <span class="inline-flex items-center px-2 py-1 bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 text-xs rounded-full">
                        <i class="fas fa-lightbulb mr-1"></i>
                        Solu√ß√µes
                    </span>
                    <span class="inline-flex items-center px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-xs rounded-full">
                        <i class="fas fa-question-circle mr-1"></i>
                        FAQs
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Footer -->
    <div class="chat-footer p-6 bg-gray-50 dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700">
        <!-- Typing Indicator -->
        <div class="typing-indicator mb-4 hidden" id="typing-indicator">
            <div class="flex items-center space-x-2 text-gray-500 dark:text-gray-400">
                <div class="flex space-x-1">
                    <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.1s;"></div>
                    <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                </div>
                <span class="text-sm">Digitando...</span>
            </div>
        </div>

        <!-- Input Container -->
        <div class="relative">
            <div class="flex items-end space-x-4">
                <!-- Text Input -->
                <div class="flex-1 relative">
                    <textarea 
                        id="chat-input" 
                        class="w-full px-4 py-3 pr-12 bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-600 rounded-2xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all duration-300 resize-none text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400" 
                        rows="1" 
                        placeholder="Digite sua mensagem..."
                        style="min-height: 48px; max-height: 120px;"
                    ></textarea>
                    
                    <!-- Character Counter -->
                    <div class="absolute bottom-2 right-14 text-xs text-gray-400 dark:text-gray-500">
                        <span id="char-count">0</span>/500
                    </div>
                    
                    <!-- Attachment Button -->
                    <button class="absolute right-2 bottom-2 p-2 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 transition-colors duration-200">
                        <i class="fas fa-paperclip"></i>
                    </button>
                </div>

                <!-- Send Button -->
                <button 
                    onclick="enviarMensagem()" 
                    class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white p-3 rounded-2xl transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500/50 shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                    id="send-button"
                >
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>

            <!-- Quick Actions -->
            <div class="mt-3 flex flex-wrap gap-2">
                <button class="quick-action px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 text-sm rounded-full hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors duration-200">
                    <i class="fas fa-search mr-1"></i>Buscar FAQ
                </button>
                <button class="quick-action px-3 py-1 bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 text-sm rounded-full hover:bg-green-200 dark:hover:bg-green-800 transition-colors duration-200">
                    <i class="fas fa-plus mr-1"></i>Novo Chamado
                </button>
                <button class="quick-action px-3 py-1 bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 text-sm rounded-full hover:bg-purple-200 dark:hover:bg-purple-800 transition-colors duration-200">
                    <i class="fas fa-history mr-1"></i>Hist√≥rico
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const chatBody = document.getElementById('chat-body');
    const chatInput = document.getElementById('chat-input');
    const typingIndicator = document.getElementById('typing-indicator');
    const sendButton = document.getElementById('send-button');
    const charCount = document.getElementById('char-count');
    let chatState = 'normal';
    let lastOptions = [];

    // Auto-resize textarea
    chatInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        
        // Update character count
        const count = this.value.length;
        charCount.textContent = count;
        
        // Change color based on limit
        if (count > 450) {
            charCount.className = 'text-red-500';
        } else if (count > 400) {
            charCount.className = 'text-yellow-500';
        } else {
            charCount.className = 'text-gray-400 dark:text-gray-500';
        }
        
        // Disable send button if over limit
        sendButton.disabled = count > 500;
    });

    // Enhanced message sending with loading states
    async function enviarMensagem() {
        const mensagem = chatInput.value.trim();
        if (!mensagem || mensagem.length > 500) return;

        // Add user message with improved styling
        adicionarMensagem(mensagem, 'user');
        chatInput.value = '';
        chatInput.style.height = 'auto';
        charCount.textContent = '0';
        
        // Show typing indicator
        typingIndicator.classList.remove('hidden');
        sendButton.disabled = true;
        sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        const statusMessage = adicionarMensagem('Processando sua solicita√ß√£o...', 'bot', true, null, true);
        chatBody.scrollTop = chatBody.scrollHeight;

        try {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mensagem: mensagem })
            });
            const data = await response.json();
            
            chatBody.removeChild(statusMessage);
            adicionarMensagem(data.text, 'bot', data.html, data.options);
            chatState = data.state || 'normal';
            
            if (chatState === 'faq_selection') {
                chatInput.placeholder = 'Clique em uma FAQ acima ou digite uma nova mensagem...';
            } else {
                chatInput.placeholder = 'Digite sua mensagem...';
            }
        } catch (error) {
            chatBody.removeChild(statusMessage);
            adicionarMensagem('‚ùå Ops! Algo deu errado. Tente novamente em alguns instantes.', 'bot');
        } finally {
            typingIndicator.classList.add('hidden');
            sendButton.disabled = false;
            sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
            chatBody.scrollTop = chatBody.scrollHeight;
        }
    }

    // Enhanced message display function
    function adicionarMensagem(texto, tipo, isHtml = false, options = [], isSearching = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${tipo} flex items-start space-x-4 mb-6 animate-slide-in`;
        
        const avatarDiv = document.createElement('div');
        if (tipo === 'user') {
            avatarDiv.className = 'avatar w-10 h-10 bg-gradient-to-br from-green-500 to-blue-600 rounded-xl flex items-center justify-center flex-shrink-0 shadow-lg order-2';
            avatarDiv.innerHTML = '<i class="fas fa-user text-white text-sm"></i>';
            messageDiv.classList.add('flex-row-reverse');
        } else {
            avatarDiv.className = 'avatar w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center flex-shrink-0 shadow-lg';
            avatarDiv.innerHTML = '<i class="fas fa-robot text-white text-sm"></i>';
        }
        
        const bubbleDiv = document.createElement('div');
        if (tipo === 'user') {
            bubbleDiv.className = 'message-bubble bg-gradient-to-br from-blue-500 to-purple-600 text-white p-4 rounded-2xl rounded-tr-md max-w-xs lg:max-w-md shadow-lg';
        } else {
            bubbleDiv.className = 'message-bubble bg-gradient-to-br from-gray-100 to-gray-50 dark:from-gray-700 dark:to-gray-600 text-gray-800 dark:text-gray-100 p-4 rounded-2xl rounded-tl-md max-w-xs lg:max-w-md shadow-lg';
        }

        if (isSearching) {
            bubbleDiv.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.1s;"></div>
                        <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                    </div>
                    <span class="text-sm">Buscando no banco de dados...</span>
                </div>
            `;
        } else {
            if (isHtml) {
                bubbleDiv.innerHTML = texto;
                // Style embedded content
                const videos = bubbleDiv.querySelectorAll('video, iframe');
                videos.forEach(video => {
                    video.classList.add('rounded-lg', 'mt-2');
                    video.style.maxWidth = '100%';
                });
                const images = bubbleDiv.querySelectorAll('img');
                images.forEach(image => {
                    image.classList.add('rounded-lg', 'mt-2', 'shadow-md');
                    image.style.maxWidth = '100%';
                });
            } else {
                bubbleDiv.textContent = texto;
            }
        }

        // Add timestamp
        if (!isSearching) {
            const timestamp = document.createElement('div');
            timestamp.className = 'text-xs opacity-70 mt-2';
            timestamp.textContent = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            bubbleDiv.appendChild(timestamp);
        }

        // Add FAQ options with improved styling
        if (options && options.length > 0) {
            const optionsString = JSON.stringify(options);
            if (optionsString !== JSON.stringify(lastOptions)) {
                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'mt-4 space-y-2';
                
                const optionsHeader = document.createElement('div');
                optionsHeader.className = 'text-xs font-semibold text-blue-600 dark:text-blue-400 uppercase tracking-wide mb-2';
                optionsHeader.textContent = 'Perguntas Frequentes';
                optionsDiv.appendChild(optionsHeader);
                
                options.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.className = 'w-full text-left p-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-xl hover:bg-blue-50 dark:hover:bg-gray-700 hover:border-blue-300 dark:hover:border-blue-500 transition-all duration-200 text-sm shadow-sm hover:shadow-md transform hover:-translate-y-0.5';
                    button.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span class="font-medium">${option.question}</span>
                            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                        </div>
                    `;
                    button.onclick = () => selecionarFAQ(option.id);
                    optionsDiv.appendChild(button);
                });
                
                bubbleDiv.appendChild(optionsDiv);
                lastOptions = options;
            }
        }

        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(bubbleDiv);
        chatBody.appendChild(messageDiv);
        
        // Smooth scroll to bottom
        setTimeout(() => {
            chatBody.scrollTo({
                top: chatBody.scrollHeight,
                behavior: 'smooth'
            });
        }, 100);
        
        return messageDiv;
    }

    // FAQ selection with loading state
    async function selecionarFAQ(faqId) {
        const statusMessage = adicionarMensagem('Carregando informa√ß√µes...', 'bot', true, null, true);
        
        try {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mensagem: `faq_${faqId}` })
            });
            const data = await response.json();
            
            chatBody.removeChild(statusMessage);
            adicionarMensagem(data.text, 'bot', data.html, data.options);
            chatState = data.state || 'normal';
            chatInput.placeholder = chatState === 'faq_selection' ? 'Clique em uma FAQ acima ou digite uma nova mensagem...' : 'Digite sua mensagem...';
        } catch (error) {
            chatBody.removeChild(statusMessage);
            adicionarMensagem('‚ùå Erro ao carregar FAQ. Tente novamente.', 'bot');
        }
    }

    // Enhanced keyboard shortcuts
    chatInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            enviarMensagem();
        }
        
        // Ctrl/Cmd + K for quick search
        if ((event.ctrlKey || event.metaKey) && event.key === 'k') {
            event.preventDefault();
            chatInput.value = 'buscar ';
            chatInput.focus();
        }
    });

    // Quick actions functionality
    document.querySelectorAll('.quick-action').forEach(button => {
        button.addEventListener('click', function() {
            const action = this.textContent.trim();
            if (action.includes('FAQ')) {
                chatInput.value = 'mostrar faqs';
            } else if (action.includes('Chamado')) {
                chatInput.value = 'criar novo chamado';
            } else if (action.includes('Hist√≥rico')) {
                chatInput.value = 'mostrar hist√≥rico';
            }
            chatInput.focus();
        });
    });

    // Initialize
    window.addEventListener('load', () => {
        chatBody.scrollTop = chatBody.scrollHeight;
        chatInput.focus();
    });
</script>

<style>
    @keyframes slide-in {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-slide-in {
        animation: slide-in 0.3s ease-out;
    }

    .chat-body::-webkit-scrollbar {
        width: 8px;
    }

    .chat-body::-webkit-scrollbar-track {
        background: transparent;
    }

    .chat-body::-webkit-scrollbar-thumb {
        background: rgba(156, 163, 175, 0.5);
        border-radius: 4px;
    }

    .chat-body::-webkit-scrollbar-thumb:hover {
        background: rgba(156, 163, 175, 0.7);
    }
</style>