{% extends "admin_base.html" %}

{% block title %}Admin - Caça ao Tesouro{% endblock %}
{% block page_title %}Gerir Caça ao Tesouro{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    
    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-8">
        <h2 class="text-xl font-semibold mb-4">Criar Nova Caça ao Tesouro</h2>
        <form method="POST" action="{{ url_for('admin_hunts') }}" class="space-y-4">
            {{ form.csrf_token }}
            <input type="hidden" name="action" value="create_hunt">
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nome do Evento</label>
                <input type="text" name="name" required class="mt-1 block w-full rounded-md dark:bg-gray-700 border-gray-300 dark:border-gray-600 shadow-sm">
            </div>
            <div>
                <label for="description" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Descrição</label>
                <textarea name="description" rows="3" class="mt-1 block w-full rounded-md dark:bg-gray-700 border-gray-300 dark:border-gray-600 shadow-sm"></textarea>
            </div>
            <div>
                <label for="reward_points" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Pontos de Recompensa</label>
                <input type="number" name="reward_points" value="100" class="mt-1 block w-full rounded-md dark:bg-gray-700 border-gray-300 dark:border-gray-600 shadow-sm">
            </div>
            <div class="flex items-center">
                <input type="checkbox" name="is_active" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label class="ml-2 text-sm text-gray-900 dark:text-gray-200">Ativar este evento? (Apenas um pode estar ativo por vez)</label>
            </div>
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">Criar Evento</button>
        </form>
    </div>

    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
        <h2 class="text-2xl font-semibold mb-6">Eventos Criados</h2>
        <div class="space-y-6">
            {% for hunt in hunts %}
            <div class="border border-gray-200 dark:border-gray-700 p-4 rounded-lg">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-lg font-semibold">{{ hunt.name }} {% if hunt.is_active %}<span class="text-green-500 font-semibold">(Ativo)</span>{% endif %}</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Recompensa: {{ hunt.reward_points }} pontos</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <a href="{{ url_for('admin_edit_hunt', hunt_id=hunt.id) }}" class="text-sm text-blue-500 hover:underline">Editar Evento</a>
                        <form method="POST" action="{{ url_for('delete_hunt', hunt_id=hunt.id) }}" onsubmit="return confirm('Tem a certeza que quer apagar este evento e todos os seus passos?');">
                            {{ form.csrf_token }}
                            <button type="submit" class="text-sm text-red-500 hover:underline">Apagar Evento</button>
                        </form>
                    </div>
                    </div>

                <div class="mt-4 space-y-2">
                    <h4 class="text-md font-semibold">Passos:</h4>
                    {% for step in hunt.steps %}
                    <div class="border dark:border-gray-600 p-3 rounded-md bg-gray-50 dark:bg-gray-700/50">
                        <p><strong>Passo {{ step.step_number }}:</strong> {{ step.clue_text }}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400"><strong>Alvo:</strong> {{ step.target_type }} contendo "{{ step.target_identifier }}"</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400"><strong>Próxima Pista:</strong> "{{ step.hidden_clue }}"</p>
                        <form method="POST" action="{{ url_for('delete_hunt_step', step_id=step.id) }}" onsubmit="return confirm('Tem a certeza que quer apagar este passo?');">
                            {{ form.csrf_token }}
                            <button type="submit" class="text-red-500 hover:text-red-700 text-xs font-semibold">APAGAR</button>
                        </form>
                    </div>
                    {% else %}
                    <p class="text-sm text-gray-500">Nenhum passo criado para este evento.</p>
                    {% endfor %}
                </div>

                <details class="mt-4">
                    <summary class="cursor-pointer text-green-500 hover:underline">Adicionar Novo Passo</summary>
                    <form method="POST" action="{{ url_for('admin_hunts') }}" class="mt-2 space-y-3 p-4 border dark:border-gray-700 rounded-md">
                        {{ form.csrf_token }}
                        <input type="hidden" name="action" value="create_step">
                        <input type="hidden" name="hunt_id" value="{{ hunt.id }}">
                        <div>
                            <label class="block text-sm">Nº do Passo</label>
                            <input type="number" name="step_number" required class="mt-1 w-full text-sm rounded-md dark:bg-gray-700 border-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm">Texto da Pista (o que o bot diz)</label>
                            <textarea name="clue_text" required rows="2" class="mt-1 w-full text-sm rounded-md dark:bg-gray-700 border-gray-600"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm">Tipo de Alvo</label>
                            <select name="target_type" class="mt-1 w-full text-sm rounded-md dark:bg-gray-700 border-gray-600">
                                <option value="FAQ">Pergunta da FAQ</option>
                                <option value="CHALLENGE">Título do Desafio</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm">Identificador do Alvo (texto a ser encontrado)</label>
                            <input type="text" name="target_identifier" required class="mt-1 w-full text-sm rounded-md dark:bg-gray-700 border-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm">Pista Oculta (revelada ao completar o passo)</label>
                            <textarea name="hidden_clue" required rows="2" class="mt-1 w-full text-sm rounded-md dark:bg-gray-700 border-gray-600"></textarea>
                        </div>
                        <button type="submit" class="bg-green-600 text-white px-3 py-1 text-sm rounded-md hover:bg-green-700">Adicionar Passo</button>
                    </form>
                </details>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}