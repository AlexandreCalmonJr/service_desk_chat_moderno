{% extends "base_user.html" %}

{% block title %}Desafios - Service Desk{% endblock %}

{% block content %}
<div class="w-full max-w-6xl mx-auto px-4">
    <div class="text-center mb-10">
        <h1 class="text-4xl font-bold text-gray-900 dark:text-white">Central de Desafios</h1>
        <p class="text-gray-500 dark:text-gray-400 mt-2">Teste os seus conhecimentos, ganhe pontos e suba no ranking!</p>
    </div>

    <!-- Mensagens Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="p-4 mb-4 text-sm rounded-lg {% if category == 'error' %} bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-200 {% elif category == 'success' %} bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-200 {% else %} bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-200 {% endif %}" role="alert">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    
    <div class="mb-12">
        <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-200 mb-4 border-b-2 border-blue-500 pb-2">DisponÃ­veis para VocÃª</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {% for challenge in unlocked_challenges %}
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 flex flex-col justify-between">
                    <div>
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center">
                                <i class="fas fa-gamepad text-yellow-500 text-2xl mr-3"></i>
                                <h3 class="text-lg font-bold">{{ challenge.title }}</h3>
                            </div>
                             <span class="px-2 py-1 text-xs font-bold rounded-full {{ 'bg-blue-500 text-white' if challenge.challenge_type == 'code' else 'bg-green-500 text-white' }}">
                                {{ challenge.challenge_type | upper }}
                            </span>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4 min-h-[60px]">{{ challenge.description }}</p>
                        <div class="text-xs font-mono bg-gray-100 dark:bg-gray-700 p-2 rounded mb-4">
                            <p><strong>NÃ­vel:</strong> {{ challenge.level_required }}</p>
                            <p><strong>Recompensa:</strong> {{ challenge.points_reward }} Pontos</p>
                            {% if challenge.is_team_challenge %}
                                <p><strong>Tipo:</strong> Desafio de Time</p>
                            {% endif %}
                        </div>
                        
                        {% if challenge.hint %}
                            <div id="hint-area-{{ challenge.id }}" class="hidden my-2 p-3 bg-yellow-100 dark:bg-yellow-900/50 rounded-lg text-sm transition-all">
                            </div>
                            <button id="hint-button-{{ challenge.id }}" onclick="getHint({{ challenge.id }}, {{ challenge.hint_cost }})" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 w-full transition mb-2 text-sm">
                                <i class="fas fa-lightbulb"></i> Pedir Dica (-{{ challenge.hint_cost }} Pontos)
                            </button>
                        {% endif %}
                    </div>
                    
                    <div>
                        {% if challenge.is_team_challenge and not current_user.team %}
                            <div class="text-center p-2 mt-2 bg-gray-200 dark:bg-gray-700 rounded-lg">
                                <p class="text-sm font-semibold">VocÃª precisa de estar num time para fazer este desafio.</p>
                                <a href="{{ url_for('teams_list') }}" class="text-blue-500 hover:underline text-xs">Ver times</a>
                            </div>
                        {% else %}
                            <form method="POST" action="{{ url_for('submit_challenge', challenge_id=challenge.id) }}" class="mt-4">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                
                                <!-- LÃ“GICA DO CAMPO DE RESPOSTA -->
                                {% if challenge.challenge_type == 'code' %}
                                    <label for="answer-{{ challenge.id }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Seu CÃ³digo:</label>
                                    <textarea name="answer" id="answer-{{ challenge.id }}" rows="8" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 font-mono text-sm" placeholder="Escreva seu cÃ³digo aqui..."></textarea>
                                {% else %}
                                    <label for="answer-{{ challenge.id }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Sua Resposta:</label>
                                    <input type="text" name="answer" id="answer-{{ challenge.id }}" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="Digite a sua resposta aqui...">
                                {% endif %}

                                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 mt-2 w-full font-semibold transition">Enviar Resposta</button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <p class="text-gray-500 dark:text-gray-400 md:col-span-3 text-center">ParabÃ©ns! VocÃª completou todos os desafios disponÃ­veis para o seu nÃ­vel.</p>
            {% endfor %}
        </div>
    </div>
    
    {% if locked_challenges %}
    <div class="mt-12">
        <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-200 mb-4 border-b-2 border-gray-500 pb-2">Desafios Bloqueados</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for challenge in locked_challenges %}
            <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 text-center opacity-60">
                <span class="text-2xl">ðŸ”’</span>
                <h3 class="font-semibold text-gray-700 dark:text-gray-300 mt-2">{{ challenge.title }}</h3>
                <p class="text-xs text-gray-500 dark:text-gray-400">Requer nÃ­vel: {{ challenge.level_required }}</p>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

</div>

<script>
    async function getHint(challengeId, hintCost) {
        if (!confirm(`VocÃª tem a certeza que quer gastar ${hintCost} pontos para ver esta dica?`)) {
            return;
        }

        const hintButton = document.getElementById(`hint-button-${challengeId}`);

        try {
            // Adicionando CSRF token no fetch POST
            const csrfToken = "{{ csrf_token() }}";
            const response = await fetch(`/challenges/hint/${challengeId}`, { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            });
            const data = await response.json();

            if (response.ok) {
                const hintArea = document.getElementById(`hint-area-${challengeId}`);
                hintArea.innerHTML = `<strong>Dica:</strong> ${data.hint}`;
                hintArea.classList.remove('hidden');
                
                hintButton.disabled = true;
                hintButton.textContent = 'Dica Revelada!';
                hintButton.classList.add('bg-gray-500', 'hover:bg-gray-500');

            } else {
                alert(data.error || 'Ocorreu um erro.');
            }
        } catch (error) {
            console.error('Erro ao buscar dica:', error);
            alert('NÃ£o foi possÃ­vel conectar ao servidor para obter a dica.');
        }
    }
</script>
{% endblock %}

