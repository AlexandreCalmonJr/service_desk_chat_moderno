{% extends "base_user.html" %}

{% block title %}Desafios - Service Desk{% endblock %}

{% block head_extra %}
<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/dracula.min.css">
<style>
    /* Estilização para o container do CodeMirror */
    .CodeMirror {
        border: 1px solid #374151; /* dark:border-gray-700 */
        border-radius: 0.5rem;
        height: 200px; /* Altura padrão, pode ajustar */
        font-family: 'Fira Code', 'monospace';
    }
    .dark .CodeMirror {
        border-color: #4b5563;
    }
</style>
{% endblock %}


{% block content %}
<div class="w-full max-w-6xl mx-auto py-8 px-4">
    <div class="text-center mb-10">
        <h1 class="text-4xl font-bold text-gray-900 dark:text-white">Central de Desafios</h1>
        <p class="text-gray-500 dark:text-gray-400 mt-2">Teste os seus conhecimentos, ganhe pontos e suba no ranking!</p>
    </div>

    <!-- Seção de Desafios Disponíveis -->
    <div class="mb-12">
        <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-200 mb-4 border-b-2 border-blue-500 pb-2">Disponíveis para Você</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {% for challenge in unlocked_challenges %}
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 flex flex-col justify-between">
                    <div>
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center">
                                <i class="fas fa-gamepad text-yellow-500 text-2xl mr-3"></i>
                                <h3 class="text-lg font-bold">{{ challenge.title }}</h3>
                            </div>
                            {% if challenge.challenge_type == 'code' %}
                                <span class="bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full" title="Desafio de Código">CÓDIGO</span>
                            {% elif challenge.is_team_challenge %}
                                <span class="bg-purple-500 text-white text-xs font-bold px-2 py-1 rounded-full" title="Desafio de Time">TIME</span>
                            {% endif %}
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4 min-h-[60px]">{{ challenge.description }}</p>
                        <div class="text-xs font-mono bg-gray-100 dark:bg-gray-700 p-2 rounded mb-4">
                            <p><strong>Nível:</strong> {{ challenge.level_required }}</p>
                            <p><strong>Recompensa:</strong> {{ challenge.points_reward }} Pontos</p>
                        </div>
                    </div>
                    
                    <div>
                        {% if challenge.is_team_challenge and not current_user.team %}
                            <div class="text-center p-2 mt-2 bg-gray-200 dark:bg-gray-700 rounded-lg">
                                <p class="text-sm font-semibold">Você precisa estar em um time para fazer este desafio.</p>
                                <a href="{{ url_for('teams_list') }}" class="text-blue-500 hover:underline text-xs">Ver times</a>
                            </div>
                        {% else %}
                            <form method="POST" action="{{ url_for('submit_challenge', challenge_id=challenge.id) }}" class="mt-4 challenge-form">
                                {{ form.csrf_token }}
                                {% if challenge.challenge_type == 'code' %}
                                    <textarea name="answer" id="code-editor-{{ challenge.id }}" class="code-editor-textarea w-full p-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700 font-mono" placeholder="Escreva seu código aqui..."></textarea>
                                {% else %}
                                    <input type="text" name="answer" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="Digite a sua resposta aqui...">
                                {% endif %}
                                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 mt-2 w-full font-semibold transition">Enviar Resposta</button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <p class="text-gray-500 dark:text-gray-400 md:col-span-3">Parabéns! Você completou todos os desafios disponíveis para o seu nível.</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- CodeMirror JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/edit/closebrackets.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializa um editor para cada textarea de desafio de código
    document.querySelectorAll('.code-editor-textarea').forEach(textarea => {
        const editor = CodeMirror.fromTextArea(textarea, {
            lineNumbers: true,
            mode: 'python',
            theme: 'dracula',
            autoCloseBrackets: true
        });

        // Encontra o formulário pai do editor
        const form = textarea.closest('form');
        
        // Adiciona um listener para o evento de 'submit' do formulário
        form.addEventListener('submit', function() {
            // Antes de enviar, atualiza o valor da textarea original
            // com o conteúdo atual do editor CodeMirror.
            textarea.value = editor.getValue();
        });
    });
});
</script>

{% endblock %}

